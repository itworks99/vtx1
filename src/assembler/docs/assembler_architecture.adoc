= VTX1 Assembler Architecture
:toc: left
:icons: font

== Overview

The VTX1 assembler is designed as a multi-pass assembler to convert VTX1 assembly language into binary machine code for the VTX1 ternary processor. This document outlines the architecture and design principles of the assembler.

== Architecture Components

=== 1. Lexer (Tokenization)

The lexer processes the input source code and converts it into a stream of tokens. Each token represents a meaningful element in the assembly language such as:

* Mnemonics (e.g., ADD, SUB, LD)
* Registers (e.g., T0, TA, VA)
* Literals (decimal, binary, ternary)
* Labels and symbols
* Directives and special characters

=== 2. Parser

The parser processes the token stream and builds an abstract syntax tree (AST) that represents the structure of the program. It handles:

* Instruction recognition
* Operand validation
* VLIW grouping for parallel operations
* Directive processing
* Label definition and usage

=== 3. Symbol Table Manager

Manages symbol resolution including:

* Label definitions and references
* Global and local symbols
* Address calculation
* Forward references

=== 4. Code Generator

Converts the parsed instructions into binary code according to the VTX1 instruction encoding:

* 96-bit VLIW instruction words (3 operations per word)
* 36-bit ternary word encoding
* Balanced ternary literal encoding
* Address resolution

=== 5. Error Handler

Provides comprehensive error detection and reporting:

* Syntax errors
* Semantic errors (e.g., invalid register usage)
* Symbol resolution errors
* Range and value validation

=== 6. Output Formatter

Generates the final output in the required format:

* Binary file format
* Hexadecimal listing
* Debug information
* Symbol table output

== Processing Flow

The assembler operates in the following stages:

1. *Lexical Analysis (ANTLR Lexer)*: Converts source code into tokens using the ANTLR-generated lexer based on `vtx1_grammar.g4`.
2. *Parsing (ANTLR Parser)*: Parses the token stream into a parse tree using the ANTLR-generated parser. Handles instruction recognition, operand validation, VLIW grouping, and directive processing.
3. *Symbol Table Management*: Tracks label definitions, references, and symbol resolution, including forward references and address calculation.
4. *Code Generation*: Converts the parse tree (or AST) into binary machine code, handling VLIW packing, ternary encoding, and directive processing.
5. *Error Handling*: Collects and reports errors and warnings at each stage, providing line/column/source context.
6. *Output Formatting*: Generates binary, hex, or objdump output, as well as optional listing and debug information.

=== Module Responsibilities

- `cmd/`: Orchestrates the assembly process, CLI, and high-level flow.
- `grammar/`: Contains ANTLR grammar and generated lexer/parser code.
- `internal/` (future): Will contain symbol table, codegen, and supporting logic.
- `test/`, `examples/`: Contain test cases and sample programs.
- `docs/`: Contains architecture, syntax, and implementation documentation.

== Implementation Choices

=== Programming Language - GoLang

Key considerations:

* Excellent string processing capabilities
* Rich library ecosystem
* Easy to extend and modify
* Good performance for an assembler of this scale
* Cross-platform compatibility

=== Error Handling Strategy

The assembler will use a comprehensive error handling strategy:

* Continue parsing after errors when possible
* Collect multiple errors before halting
* Provide clear error messages with line/column information
* Suggest potential fixes when appropriate

=== VLIW Handling

VLIW instructions (multiple operations per instruction word) will be handled through:

* Explicit grouping syntax in the assembly language
* Automatic validation of illegal operation combinations
* Resource conflict detection
* Pipeline hazard warnings

== Module Interfaces

The assembler is structured with clear interfaces between its major components:

=== Lexer/Parser (ANTLR)
- **Input:** Source code string
- **Output:** ANTLR parse tree (`antlr.ParseTree`)
- **Interface:** ANTLR-generated Go interfaces/classes

=== Parser â†’ Codegen
- **Input:** ANTLR parse tree (and/or custom AST)
- **Output:** Calls to codegen functions to emit binary
- **Interface:** Go interface for AST traversal and code emission

=== Symbol Table
- **Input:** Label definitions, references, and directives from parser
- **Output:** Resolved addresses and symbol errors
- **Interface:** Go struct with lookup, insert, and resolve methods

=== Error Handling
- **Input:** Errors from lexer, parser, codegen, and symbol table
- **Output:** Aggregated error/warning list with context
- **Interface:** Go struct with methods for add, summarize, and report
